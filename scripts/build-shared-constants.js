#!/usr/bin/env node

const fs = require('fs/promises');
const path = require('path');

const SOURCE_PATH = path.resolve(__dirname, '..', 'shared', 'constants', 'game.json');
const TARGET_PATH = path.resolve(__dirname, '..', 'public', 'js', 'shared', 'gameConstants.js');

const toExportName = (key) => key
  .replace(/([a-z0-9])([A-Z])/g, '$1_$2')
  .replace(/[-\s]/g, '_')
  .toUpperCase();

const generateModuleSource = (payload) => {
  const lines = [];
  lines.push('// This file is auto-generated by scripts/build-shared-constants.js.');
  lines.push('// Do not edit this file directly. Update shared/constants/game.json instead.');
  lines.push('');
  lines.push('const deepFreeze = (object) => {');
  lines.push('  if (object && typeof object === "object" && !Object.isFrozen(object)) {');
  lines.push('    Object.keys(object).forEach((key) => {');
  lines.push('      const value = object[key];');
  lines.push('      if (value && typeof value === "object") {');
  lines.push('        deepFreeze(value);');
  lines.push('      }');
  lines.push('    });');
  lines.push('    Object.freeze(object);');
  lines.push('  }');
  lines.push('  return object;');
  lines.push('};');
  lines.push('');
  lines.push(`const GAME_CONSTANTS = deepFreeze(${JSON.stringify(payload, null, 2)});`);
  lines.push('');
  lines.push('export { GAME_CONSTANTS };');
  lines.push('');

  Object.keys(payload).forEach((key) => {
    const exportName = toExportName(key);
    lines.push(`export const ${exportName} = GAME_CONSTANTS.${key};`);
  });

  lines.push('');
  return lines.join('\n');
};

async function main() {
  const raw = await fs.readFile(SOURCE_PATH, 'utf8');
  const payload = JSON.parse(raw);
  const moduleSource = generateModuleSource(payload);

  await fs.mkdir(path.dirname(TARGET_PATH), { recursive: true });
  await fs.writeFile(TARGET_PATH, `${moduleSource}\n`, 'utf8');
}

main().catch((error) => {
  console.error('Failed to build shared game constants artifact:', error);
  process.exit(1);
});
